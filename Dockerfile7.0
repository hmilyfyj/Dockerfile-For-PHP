FROM php:7.1-fpm

MAINTAINER fengit@outlook.com

# Install modules
COPY ./sources.list /etc/apt/sources.list
RUN apt-get update \
	&& apt-get install git -y \
	vim \
	zip \
	libmcrypt-dev \
	libz-dev \
	wget \
	libfreetype6-dev \
    libjpeg62-turbo-dev \
    libmcrypt-dev \
    libpng12-dev \
    libmemcached-dev \
    libmemcached11 \
    libmemcachedutil2 \
    libmemcached-dev \
    libz-dev \
    openssh-client \
	supervisor \
    && pear update-channels \
	&& pear upgrade \
	&& pear clear-cache \
	&& docker-php-ext-install \
        mcrypt \
        mbstring \
        pdo_mysql \
        mysqli \
        zip \
        gd \
        opcache \
RUN echo "===> Installing python, sudo, and supporting tools..."  && \
    apt-get install --fix-missing          && \
    DEBIAN_FRONTEND=noninteractive         \
    apt-get install -y                     \
        python python-yaml sudo            \
        curl gcc python-pip python-dev libffi-dev libssl-dev  && \
    apt-get -y --purge remove python-cffi          && \
    pip install --upgrade cffi                     && \
    \
    \
    echo "===> Installing Ansible..."   && \
    pip install ansible==1.9.4      && \
    \
    \
    echo "===> Installing handy tools (not absolutely required)..."  && \
    apt-get install -y sshpass openssh-client
RUN apt-get install -y \
        libmemcached11 \
        libmemcachedutil2 \
        libmemcached-dev \
        libz-dev \
        git \
    && cd /root \
    && git clone -b php7 https://github.com/php-memcached-dev/php-memcached \
    && cd php-memcached \
    && phpize \
    && ./configure \
    && make \
    && make install \
    && cd .. \
    && rm -rf  php-memcached \
    && echo extension=memcached.so >> /usr/local/etc/php/conf.d/memcached.ini \
    && apt-get remove -y build-essential libmemcached-dev libz-dev \
    && apt-get remove -y \
        libmemcached-dev \
        libz-dev \
    && apt-get autoremove -y \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean
RUN curl -sS https://getcomposer.org/installer | php \
	&& mv composer.phar /usr/local/bin/composer \
	&& composer config -g repo.packagist composer https://packagist.phpcomposer.com \
	&& composer global require "phpunit/phpunit=5.5.*" \
	&& composer global require "laravel/installer" \
	&& echo "export PATH=$PATH:/root/.composer/vendor/bin" >> ~/.bashrc \
	&& ansible-galaxy install carlosbuenosvinos.ansistrano-deploy carlosbuenosvinos.ansistrano-rollback \
	&& ssh-keygen -t rsa -N '' -f ~/.ssh/id_rsa -q -b 2048 \
	&& cat ~/.ssh/id_rsa \
	&& ssh-keyscan coding.net >> /root/.ssh/known_hosts && ssh-keyscan github.com >> /root/.ssh/known_hosts && ssh-keyscan 121.40.40.157 >> /root/.ssh/known_hosts && ssh-keyscan -p 10022 121.40.40.157 >> /root/.ssh/known_hosts
ADD php.ini-production /usr/local/etc/php/php.ini
#RUN cd /usr/share/nginx/html && composer install --prefer-dist --no-dev --optimize-autoloader -vvvv
CMD ["php-fpm"]